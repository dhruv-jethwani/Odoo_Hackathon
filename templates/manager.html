{% extends "base.html" %}
{% block content %}

<div class="w-full min-h-screen bg-gradient-to-br from-gray-900 via-black to-purple-900 text-white px-4 py-8">
    <div class="max-w-6xl mx-auto">

        <!-- Heading -->
        <h1 class="text-3xl font-bold mb-6">Manager Dashboard</h1>

        <!-- Filters and Search -->
        <div class="flex flex-col md:flex-row md:justify-between gap-4 mb-6">
            <input type="text" id="searchInput" placeholder="Search by employee or description"
                class="p-2 rounded-md border border-zinc-700 bg-[#141414] focus:ring-2 focus:ring-violet-500 outline-none text-sm w-full md:w-1/2">
            <select id="filterStatus"
                class="p-2 rounded-md border border-zinc-700 bg-[#141414] focus:ring-2 focus:ring-violet-500 outline-none text-sm w-full md:w-1/4">
                <option value="">All Status</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
                <option value="escalated">Escalated</option>
            </select>
        </div>

        <!-- Team Expenses Table -->
        <div class="bg-[#181818] shadow-2xl rounded-xl p-4 overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="border-b border-zinc-700">
                        <th class="p-2">ID</th>
                        <th class="p-2">Employee</th>
                        <th class="p-2">Description</th>
                        <th class="p-2">Amount (₹)</th>
                        <th class="p-2">Date</th>
                        <th class="p-2">Status</th>
                        <th class="p-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody">
                    {% if approvals %}
                        {% for expense in approvals %}
                        <tr class="border-b border-zinc-700">
                            <td class="p-2">{{ expense.id }}</td>
                            <td class="p-2">{{ expense.requestor_username }}</td>
                            <td class="p-2">{{ expense.description or '-' }}</td>
                            <td class="p-2">₹{{ expense.amount or 0 }}</td>
                            <td class="p-2">{{ expense.created_at[:10] if expense.created_at else '-' }}</td>
                            <td class="p-2">
                                {% if expense.status == 'Approved' %}
                                <span class="text-green-400 font-semibold">{{ expense.status }}</span>
                                {% elif expense.status == 'Pending' %}
                                <span class="text-yellow-400 font-semibold">{{ expense.status }}</span>
                                {% elif expense.status == 'Rejected' %}
                                <span class="text-red-500 font-semibold">{{ expense.status }}</span>
                                {% else %}
                                {{ expense.status }}
                                {% endif %}
                            </td>
                            <td class="p-2 flex gap-2">
                                {% if expense.status == 'Pending' %}
                                <form method="post" action="/manager/expenses/{{ expense.id }}/approve">
                                    <input type="hidden" name="approver_email" value="{{ current_user_email or '' }}" />
                                    <button type="submit"
                                        class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded-md text-sm">Approve</button>
                                </form>
                                <form method="post" action="/manager/expenses/{{ expense.id }}/reject">
                                    <input type="hidden" name="approver_email" value="{{ current_user_email or '' }}" />
                                    <button type="submit"
                                        class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded-md text-sm">Reject</button>
                                </form>
                                {% else %}
                                <span class="text-gray-400">No actions</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-600">No expenses to display.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const filterStatus = document.getElementById('filterStatus');
    const tableBody = document.getElementById('expenseTableBody');

    function filterExpenses() {
        const searchValue = searchInput.value.toLowerCase();
        const statusValue = filterStatus.value.toLowerCase();

        for (let row of tableBody.rows) {
            const employee = row.cells[1].textContent.toLowerCase();
            const description = row.cells[2].textContent.toLowerCase();
            const status = row.cells[5].textContent.toLowerCase();

            const matchesSearch = employee.includes(searchValue) || description.includes(searchValue);
            const matchesStatus = !statusValue || status === statusValue;

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        }
    }

    searchInput.addEventListener('input', filterExpenses);
    filterStatus.addEventListener('change', filterExpenses);
</script>

{% endblock %}