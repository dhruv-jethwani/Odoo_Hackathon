{% extends "base.html" %}
{% block content %}

<div class="w-full min-h-screen bg-gradient-to-br from-gray-900 via-black to-purple-900 text-white px-4 py-8">
    <div class="max-w-6xl mx-auto">

        <h1 class="text-3xl font-bold mb-6">All Expenses</h1>

        <!-- Filters and Search -->
        <div class="flex flex-col md:flex-row md:justify-between gap-4 mb-6">
            <input type="text" id="searchInput" placeholder="Search by user or description"
                class="p-2 rounded-md border border-zinc-700 bg-[#141414] focus:ring-2 focus:ring-violet-500 outline-none text-sm w-full md:w-1/2">
            <select id="filterStatus"
                class="p-2 rounded-md border border-zinc-700 bg-[#141414] focus:ring-2 focus:ring-violet-500 outline-none text-sm w-full md:w-1/4">
                <option value="">All Status</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>

        <!-- Approver selection moved to Approval Rules (admin_approve.html) -->

        <!-- Expenses Table -->
        <div class="bg-[#181818] shadow-2xl rounded-xl p-4 overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="border-b border-zinc-700">
                        <th class="p-2">ID</th>
                        <th class="p-2">Requestor</th>
                        <th class="p-2">Description</th>
                        <th class="p-2">Category</th>
                        <th class="p-2">Amount</th>
                        <th class="p-2">Created</th>
                        <th class="p-2">Updated</th>
                        <th class="p-2">Status</th>
                        <th class="p-2">Approver</th>
                        <th class="p-2">Approver Comments</th>
                        <th class="p-2">Receipt</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody">
                    {% if approvals %}
                        {% for approval in approvals %}
                        <tr class="border-b border-zinc-700">
                            <td class="p-2">{{ approval.id }}</td>
                            <td class="p-2">{{ approval.requestor_email or '-' }}</td>
                            <td class="p-2">{{ approval.description or '-' }}</td>
                            <td class="p-2">{{ approval.category or '-' }}</td>
                            <td class="p-2">{{ approval.amount or 0 }} {{ approval.currency or '' }}</td>
                            <td class="p-2">{{ approval.created_at[:10] if approval.created_at else '-' }}</td>
                            <td class="p-2">{{ approval.updated_at[:10] if approval.updated_at else '-' }}</td>
                            <td class="p-2">
                                {% set st = (approval.status or '') %}
                                {% if st.lower() == 'approved' %}
                                    <span class="text-green-400 font-semibold">{{ approval.status }}</span>
                                {% elif st.lower() == 'pending' %}
                                    <span class="text-yellow-400 font-semibold">{{ approval.status }}</span>
                                {% elif st.lower() == 'rejected' %}
                                    <span class="text-red-500 font-semibold">{{ approval.status }}</span>
                                {% else %}
                                    {{ approval.status }}
                                {% endif %}
                            </td>
                            <td class="p-2">{{ approval.approver_email or '-' }}</td>
                            <td class="p-2">{{ approval.approver_comments or '-' }}</td>
                            <td class="p-2">
                                {% if approval.receipt_filename %}
                                    <a href="/static/uploads/{{ approval.receipt_filename }}" class="text-sm text-violet-400">View receipt</a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="11" class="p-4 text-center text-gray-600">No approvals to display.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const filterStatus = document.getElementById('filterStatus');
    const tableBody = document.getElementById('expenseTableBody');

    function filterExpenses() {
        const searchValue = searchInput.value.toLowerCase();
        const statusValue = filterStatus.value.toLowerCase();

        for (let row of tableBody.rows) {
            const user = row.cells[1].textContent.toLowerCase();
            const description = row.cells[2].textContent.toLowerCase();
            const status = row.cells[7].textContent.toLowerCase();

            const matchesSearch = user.includes(searchValue) || description.includes(searchValue);
            const matchesStatus = !statusValue || status === statusValue;

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        }
    }

    searchInput.addEventListener('input', filterExpenses);
    filterStatus.addEventListener('change', filterExpenses);
</script>

{% endblock %}